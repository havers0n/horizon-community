-- Миграция для расширения системы шаблонов рапортов
-- Добавление новых полей для детальной информации о шаблонах

-- Добавляем новые колонки в таблицу report_templates
ALTER TABLE report_templates 
ADD COLUMN IF NOT EXISTS category TEXT NOT NULL DEFAULT 'general',
ADD COLUMN IF NOT EXISTS subcategory TEXT,
ADD COLUMN IF NOT EXISTS purpose TEXT,
ADD COLUMN IF NOT EXISTS who_fills TEXT,
ADD COLUMN IF NOT EXISTS when_used TEXT,
ADD COLUMN IF NOT EXISTS template_example TEXT,
ADD COLUMN IF NOT EXISTS filled_example TEXT,
ADD COLUMN IF NOT EXISTS difficulty TEXT DEFAULT 'medium',
ADD COLUMN IF NOT EXISTS estimated_time INTEGER,
ADD COLUMN IF NOT EXISTS required_fields TEXT[] DEFAULT '{}',
ADD COLUMN IF NOT EXISTS tags TEXT[] DEFAULT '{}';

-- Создаем индексы для новых полей
CREATE INDEX IF NOT EXISTS idx_report_templates_category ON report_templates(category);
CREATE INDEX IF NOT EXISTS idx_report_templates_subcategory ON report_templates(subcategory);
CREATE INDEX IF NOT EXISTS idx_report_templates_difficulty ON report_templates(difficulty);
CREATE INDEX IF NOT EXISTS idx_report_templates_tags ON report_templates USING GIN(tags);

-- Обновляем существующие шаблоны с новой информацией
UPDATE report_templates SET 
  category = 'police',
  subcategory = 'incident',
  purpose = 'Общий рапорт о происшествии',
  who_fills = 'Любой офицер',
  when_used = 'Любое происшествие',
  difficulty = 'easy',
  estimated_time = 10,
  required_fields = ARRAY['ДАТА', 'ВРЕМЯ', 'МЕСТО_ПРОИСШЕСТВИЯ', 'ИМЯ_ОФИЦЕРА'],
  tags = ARRAY['инцидент', 'происшествие', 'общий']
WHERE title = 'Рапорт об инциденте';

UPDATE report_templates SET 
  category = 'police',
  subcategory = 'traffic',
  purpose = 'Документирование дорожно-транспортного происшествия',
  who_fills = 'Офицер ДТП',
  when_used = 'Любое ДТП, авария, столкновение',
  difficulty = 'medium',
  estimated_time = 20,
  required_fields = ARRAY['ДАТА_ДТП', 'ВРЕМЯ_ДТП', 'МЕСТО_ДТП', 'ИМЯ_ОФИЦЕРА'],
  tags = ARRAY['дтп', 'авария', 'транспорт', 'столкновение']
WHERE title = 'Рапорт о дорожно-транспортном происшествии';

UPDATE report_templates SET 
  category = 'fire',
  subcategory = 'fire',
  purpose = 'Документирование пожара и действий по его тушению',
  who_fills = 'Руководитель тушения пожара',
  when_used = 'Любой пожар или возгорание',
  difficulty = 'medium',
  estimated_time = 15,
  required_fields = ARRAY['ДАТА_ВЫЗОВА', 'АДРЕС_ПОЖАРА', 'РУКОВОДИТЕЛЬ_ТУШЕНИЯ'],
  tags = ARRAY['пожар', 'возгорание', 'тушение']
WHERE title = 'Рапорт о пожаре';

UPDATE report_templates SET 
  category = 'ems',
  subcategory = 'medical',
  purpose = 'Документирование медицинского события и оказанной помощи',
  who_fills = 'Медицинская бригада',
  when_used = 'Любой медицинский вызов',
  difficulty = 'medium',
  estimated_time = 12,
  required_fields = ARRAY['ДАТА_И_ВРЕМЯ', 'ФИО_ПАЦИЕНТА', 'МЕД_БРИГАДА'],
  tags = ARRAY['медицина', 'пациент', 'помощь', 'вызов']
WHERE title = 'Рапорт о медицинском событии';

-- Добавляем новые полицейские шаблоны
INSERT INTO report_templates (title, body, category, subcategory, purpose, who_fills, when_used, difficulty, estimated_time, required_fields, tags, created_by) VALUES
(
  'Arrest Report',
  'РАПОРТ ОБ АРЕСТЕ

Дата ареста: {{ДАТА_АРЕСТА}}
Время ареста: {{ВРЕМЯ_АРЕСТА}}
Место ареста: {{МЕСТО_АРЕСТА}}

ДАННЫЕ АРЕСТОВАННОГО:
ФИО: {{ФИО_АРЕСТОВАННОГО}}
Дата рождения: {{ДАТА_РОЖДЕНИЯ}}
Адрес: {{АДРЕС_АРЕСТОВАННОГО}}
Телефон: {{ТЕЛЕФОН_АРЕСТОВАННОГО}}

ОБВИНЕНИЯ:
{{ОБВИНЕНИЯ}}

ОБСТОЯТЕЛЬСТВА АРЕСТА:
{{ОБСТОЯТЕЛЬСТВА_АРЕСТА}}

ПРИМЕНЕНИЕ СИЛЫ:
{{ПРИМЕНЕНИЕ_СИЛЫ}}

ИЗЪЯТОЕ ИМУЩЕСТВО:
{{ИЗЪЯТОЕ_ИМУЩЕСТВО}}

Офицер: {{ИМЯ_ОФИЦЕРА}}
Подразделение: {{ПОДРАЗДЕЛЕНИЕ}}',
  'police',
  'arrest',
  'Детали ареста и обвинения',
  'Офицер, производящий арест',
  'При аресте подозреваемого',
  'hard',
  25,
  ARRAY['ДАТА_АРЕСТА', 'ФИО_АРЕСТОВАННОГО', 'ОБВИНЕНИЯ', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['арест', 'обвинение', 'подозреваемый', 'задержание'],
  1
),
(
  'Use of Force Report',
  'РАПОРТ О ПРИМЕНЕНИИ СИЛЫ

Дата: {{ДАТА}}
Время: {{ВРЕМЯ}}
Место: {{МЕСТО}}

ОФИЦЕР:
ФИО: {{ИМЯ_ОФИЦЕРА}}
Звание: {{ЗВАНИЕ}}
Подразделение: {{ПОДРАЗДЕЛЕНИЕ}}

ПОДОЗРЕВАЕМЫЙ:
ФИО: {{ФИО_ПОДОЗРЕВАЕМОГО}}
Пол: {{ПОЛ}}
Возраст: {{ВОЗРАСТ}}

ОБСТОЯТЕЛЬСТВА:
{{ОБСТОЯТЕЛЬСТВА}}

ТИП ПРИМЕНЕННОЙ СИЛЫ:
{{ТИП_СИЛЫ}}

ОБОСНОВАНИЕ ПРИМЕНЕНИЯ СИЛЫ:
{{ОБОСНОВАНИЕ}}

ПОСЛЕДСТВИЯ:
{{ПОСЛЕДСТВИЯ}}

СВИДЕТЕЛИ:
{{СВИДЕТЕЛИ}}

Подпись офицера: ____________ ({{ИМЯ_ОФИЦЕРА}})',
  'police',
  'use_of_force',
  'Документирование применения силы',
  'Офицер/Supervisor',
  'При применении силы',
  'hard',
  30,
  ARRAY['ДАТА', 'ИМЯ_ОФИЦЕРА', 'ТИП_СИЛЫ', 'ОБОСНОВАНИЕ'],
  ARRAY['сила', 'применение', 'обоснование', 'защита'],
  1
),
(
  'Evidence/Property Report',
  'РАПОРТ ОБ ИЗЪЯТОМ ИМУЩЕСТВЕ/ДОКАЗАТЕЛЬСТВАХ

Дата изъятия: {{ДАТА_ИЗЪЯТИЯ}}
Время изъятия: {{ВРЕМЯ_ИЗЪЯТИЯ}}
Место изъятия: {{МЕСТО_ИЗЪЯТИЯ}}

ОФИЦЕР:
{{ИМЯ_ОФИЦЕРА}}

ТИП ИЗЪЯТИЯ:
{{ТИП_ИЗЪЯТИЯ}}

ОПИСАНИЕ ИЗЪЯТОГО:
{{ОПИСАНИЕ_ИЗЪЯТОГО}}

КАТЕГОРИЯ:
{{КАТЕГОРИЯ}}

СЕРИЙНЫЕ НОМЕРА:
{{СЕРИЙНЫЕ_НОМЕРА}}

ОЦЕНОЧНАЯ СТОИМОСТЬ:
{{ОЦЕНОЧНАЯ_СТОИМОСТЬ}}

МЕСТО ХРАНЕНИЯ:
{{МЕСТО_ХРАНЕНИЯ}}

ОБОСНОВАНИЕ ИЗЪЯТИЯ:
{{ОБОСНОВАНИЕ_ИЗЪЯТИЯ}}

СВИДЕТЕЛИ:
{{СВИДЕТЕЛИ}}

Подпись: ____________ ({{ИМЯ_ОФИЦЕРА}})',
  'police',
  'evidence',
  'Учёт изъятого/обнаруженного имущества/доказательств',
  'Любой офицер',
  'Изъятие, находка, конфискация',
  'medium',
  15,
  ARRAY['ДАТА_ИЗЪЯТИЯ', 'ОПИСАНИЕ_ИЗЪЯТОГО', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['изъятие', 'имущество', 'доказательства', 'конфискация'],
  1
),
(
  'Domestic Violence Report',
  'РАПОРТ О ДОМАШНЕМ НАСИЛИИ

Дата инцидента: {{ДАТА_ИНЦИДЕНТА}}
Время инцидента: {{ВРЕМЯ_ИНЦИДЕНТА}}
Место инцидента: {{МЕСТО_ИНЦИДЕНТА}}

ПОТЕРПЕВШИЙ:
ФИО: {{ФИО_ПОТЕРПЕВШЕГО}}
Пол: {{ПОЛ_ПОТЕРПЕВШЕГО}}
Возраст: {{ВОЗРАСТ_ПОТЕРПЕВШЕГО}}
Адрес: {{АДРЕС_ПОТЕРПЕВШЕГО}}

ПОДОЗРЕВАЕМЫЙ:
ФИО: {{ФИО_ПОДОЗРЕВАЕМОГО}}
Пол: {{ПОЛ_ПОДОЗРЕВАЕМОГО}}
Возраст: {{ВОЗРАСТ_ПОДОЗРЕВАЕМОГО}}
Связь с потерпевшим: {{СВЯЗЬ_С_ПОТЕРПЕВШИМ}}

ОПИСАНИЕ ИНЦИДЕНТА:
{{ОПИСАНИЕ_ИНЦИДЕНТА}}

ТИП НАСИЛИЯ:
{{ТИП_НАСИЛИЯ}}

ПОВРЕЖДЕНИЯ:
{{ПОВРЕЖДЕНИЯ}}

СВИДЕТЕЛИ:
{{СВИДЕТЕЛИ}}

ПРИНЯТЫЕ МЕРЫ:
{{ПРИНЯТЫЕ_МЕРЫ}}

Офицер: {{ИМЯ_ОФИЦЕРА}}',
  'police',
  'domestic_violence',
  'Фиксация случаев домашнего насилия',
  'Офицер, social worker',
  'Домашнее насилие',
  'hard',
  35,
  ARRAY['ДАТА_ИНЦИДЕНТА', 'ФИО_ПОТЕРПЕВШЕГО', 'ФИО_ПОДОЗРЕВАЕМОГО', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['домашнее насилие', 'потерпевший', 'подозреваемый', 'семья'],
  1
),
(
  'Field Interview Report (FIR)',
  'РАПОРТ О ПОЛЕВОМ ИНТЕРВЬЮ

Дата: {{ДАТА}}
Время: {{ВРЕМЯ}}
Место: {{МЕСТО}}

ОФИЦЕР:
{{ИМЯ_ОФИЦЕРА}}

ЛИЦО, С КОТОРЫМ ПРОВОДИЛОСЬ ИНТЕРВЬЮ:
ФИО: {{ФИО_ЛИЦА}}
Дата рождения: {{ДАТА_РОЖДЕНИЯ}}
Адрес: {{АДРЕС}}
Телефон: {{ТЕЛЕФОН}}

ПРИЧИНА ИНТЕРВЬЮ:
{{ПРИЧИНА_ИНТЕРВЬЮ}}

ОБСТОЯТЕЛЬСТВА:
{{ОБСТОЯТЕЛЬСТВА}}

ПОЛУЧЕННАЯ ИНФОРМАЦИЯ:
{{ПОЛУЧЕННАЯ_ИНФОРМАЦИЯ}}

ПОДОЗРЕНИЯ:
{{ПОДОЗРЕНИЯ}}

ДЕЙСТВИЯ:
{{ДЕЙСТВИЯ}}

Подпись офицера: ____________ ({{ИМЯ_ОФИЦЕРА}})',
  'police',
  'field_interview',
  'Фиксация общения с гражданами (подозрение, инфо)',
  'Patrol officer',
  'Street stops, подозрение',
  'easy',
  8,
  ARRAY['ДАТА', 'ФИО_ЛИЦА', 'ПРИЧИНА_ИНТЕРВЬЮ', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['интервью', 'подозрение', 'информация', 'патруль'],
  1
),
(
  'Death Investigation Report',
  'РАПОРТ О РАССЛЕДОВАНИИ СМЕРТИ

Дата обнаружения: {{ДАТА_ОБНАРУЖЕНИЯ}}
Время обнаружения: {{ВРЕМЯ_ОБНАРУЖЕНИЯ}}
Место обнаружения: {{МЕСТО_ОБНАРУЖЕНИЯ}}

ОБНАРУЖИВШИЙ:
{{ИМЯ_ОБНАРУЖИВШЕГО}}

ПОКОЙНЫЙ:
ФИО: {{ФИО_ПОКОЙНОГО}}
Дата рождения: {{ДАТА_РОЖДЕНИЯ}}
Пол: {{ПОЛ}}
Адрес: {{АДРЕС}}

ОБСТОЯТЕЛЬСТВА ОБНАРУЖЕНИЯ:
{{ОБСТОЯТЕЛЬСТВА_ОБНАРУЖЕНИЯ}}

ПРЕДВАРИТЕЛЬНАЯ ПРИЧИНА СМЕРТИ:
{{ПРИЧИНА_СМЕРТИ}}

СОСТОЯНИЕ ТЕЛА:
{{СОСТОЯНИЕ_ТЕЛА}}

СВИДЕТЕЛИ:
{{СВИДЕТЕЛИ}}

ДЕЙСТВИЯ:
{{ДЕЙСТВИЯ}}

СЛЕДОВАТЕЛЬ:
{{ИМЯ_СЛЕДОВАТЕЛЯ}}

Подпись: ____________ ({{ИМЯ_СЛЕДОВАТЕЛЯ}})',
  'police',
  'death_investigation',
  'Смерть при неясных или криминальных обстоятельствах',
  'Detective, coroner',
  'Любая смерть не "естественная"',
  'hard',
  45,
  ARRAY['ДАТА_ОБНАРУЖЕНИЯ', 'ФИО_ПОКОЙНОГО', 'ПРИЧИНА_СМЕРТИ', 'ИМЯ_СЛЕДОВАТЕЛЯ'],
  ARRAY['смерть', 'расследование', 'криминал', 'следователь'],
  1
),
(
  'Juvenile Contact Report',
  'РАПОРТ О КОНТАКТЕ С НЕСОВЕРШЕННОЛЕТНИМ

Дата контакта: {{ДАТА_КОНТАКТА}}
Время контакта: {{ВРЕМЯ_КОНТАКТА}}
Место контакта: {{МЕСТО_КОНТАКТА}}

ОФИЦЕР:
{{ИМЯ_ОФИЦЕРА}}

НЕСОВЕРШЕННОЛЕТНИЙ:
ФИО: {{ФИО_НЕСОВЕРШЕННОЛЕТНЕГО}}
Дата рождения: {{ДАТА_РОЖДЕНИЯ}}
Пол: {{ПОЛ}}
Адрес: {{АДРЕС}}

РОДИТЕЛИ/ОПЕКУНЫ:
{{РОДИТЕЛИ_ОПЕКУНЫ}}

ПРИЧИНА КОНТАКТА:
{{ПРИЧИНА_КОНТАКТА}}

ОБСТОЯТЕЛЬСТВА:
{{ОБСТОЯТЕЛЬСТВА}}

ДЕЙСТВИЯ:
{{ДЕЙСТВИЯ}}

УВЕДОМЛЕНИЕ РОДИТЕЛЕЙ:
{{УВЕДОМЛЕНИЕ_РОДИТЕЛЕЙ}}

Подпись офицера: ____________ ({{ИМЯ_ОФИЦЕРА}})',
  'police',
  'juvenile',
  'Работа с несовершеннолетними',
  'Juvenile officer',
  'При контакте с несовершеннолетними',
  'medium',
  20,
  ARRAY['ДАТА_КОНТАКТА', 'ФИО_НЕСОВЕРШЕННОЛЕТНЕГО', 'РОДИТЕЛИ_ОПЕКУНЫ', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['несовершеннолетний', 'контакт', 'родители', 'опека'],
  1
),
(
  'Pursuit Report',
  'РАПОРТ О ПОЛИЦЕЙСКОЙ ПОГОНЕ

Дата погони: {{ДАТА_ПОГОНИ}}
Время начала: {{ВРЕМЯ_НАЧАЛА}}
Время окончания: {{ВРЕМЯ_ОКОНЧАНИЯ}}

ОФИЦЕР:
{{ИМЯ_ОФИЦЕРА}}

ТРАНСПОРТНОЕ СРЕДСТВО ПОДОЗРЕВАЕМОГО:
Марка/Модель: {{МАРКА_МОДЕЛЬ_ТС}}
Цвет: {{ЦВЕТ_ТС}}
Гос. номер: {{ГОС_НОМЕР_ТС}}

ПРИЧИНА ПРЕСЛЕДОВАНИЯ:
{{ПРИЧИНА_ПРЕСЛЕДОВАНИЯ}}

МАРШРУТ ПОГОНИ:
{{МАРШРУТ_ПОГОНИ}}

СКОРОСТЬ:
Максимальная: {{МАКС_СКОРОСТЬ}}
Средняя: {{СРЕДНЯЯ_СКОРОСТЬ}}

ОПАСНОСТЬ ДЛЯ ОБЩЕСТВЕННОСТИ:
{{ОПАСНОСТЬ_ДЛЯ_ОБЩЕСТВЕННОСТИ}}

РЕЗУЛЬТАТ:
{{РЕЗУЛЬТАТ}}

ПОДТВЕРЖДЕНИЕ СУПЕРВАЙЗЕРА:
{{ПОДТВЕРЖДЕНИЕ_СУПЕРВАЙЗЕРА}}

Подпись: ____________ ({{ИМЯ_ОФИЦЕРА}})',
  'police',
  'pursuit',
  'Документирует полицейскую погоню',
  'Офицер/Супервайзер',
  'Любая погоня',
  'hard',
  30,
  ARRAY['ДАТА_ПОГОНИ', 'ПРИЧИНА_ПРЕСЛЕДОВАНИЯ', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['погоня', 'преследование', 'транспорт', 'опасность'],
  1
),
(
  'Supplemental Report',
  'ДОПОЛНИТЕЛЬНЫЙ РАПОРТ

Номер основного рапорта: {{НОМЕР_ОСНОВНОГО_РАПОРТА}}
Дата: {{ДАТА}}
Время: {{ВРЕМЯ}}

ОФИЦЕР:
{{ИМЯ_ОФИЦЕРА}}

ПРИЧИНА ДОПОЛНЕНИЯ:
{{ПРИЧИНА_ДОПОЛНЕНИЯ}}

НОВАЯ ИНФОРМАЦИЯ:
{{НОВАЯ_ИНФОРМАЦИЯ}}

ДОПОЛНИТЕЛЬНЫЕ ДЕЙСТВИЯ:
{{ДОПОЛНИТЕЛЬНЫЕ_ДЕЙСТВИЯ}}

СВЯЗАННЫЕ ДОКУМЕНТЫ:
{{СВЯЗАННЫЕ_ДОКУМЕНТЫ}}

Подпись: ____________ ({{ИМЯ_ОФИЦЕРА}})',
  'police',
  'supplemental',
  'Дополнение к основному рапорту',
  'Любой офицер',
  'Когда есть новые сведения',
  'easy',
  10,
  ARRAY['НОМЕР_ОСНОВНОГО_РАПОРТА', 'ПРИЧИНА_ДОПОЛНЕНИЯ', 'ИМЯ_ОФИЦЕРА'],
  ARRAY['дополнение', 'новые сведения', 'дополнительно'],
  1
); 