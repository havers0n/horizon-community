# Система рапортов - Документация

## Обзор

Система рапортов представляет собой интегрированное решение для создания, управления и заполнения шаблонов рапортов. Система основана на логике из проекта "единая-система-учета-рапортов" и интегрирована в основное приложение.

## Архитектура

### База данных

#### Таблица `report_templates`
Хранит шаблоны рапортов, созданные администраторами и супервайзерами.

```sql
CREATE TABLE report_templates (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    body TEXT NOT NULL,
    department_id INTEGER REFERENCES departments(id),
    created_by INTEGER NOT NULL REFERENCES users(id),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);
```

#### Таблица `filled_reports`
Хранит заполненные пользователями рапорты на основе шаблонов.

```sql
CREATE TABLE filled_reports (
    id SERIAL PRIMARY KEY,
    template_id INTEGER NOT NULL REFERENCES report_templates(id),
    author_id INTEGER NOT NULL REFERENCES users(id),
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'approved', 'rejected')),
    supervisor_comment TEXT,
    submitted_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);
```

### Компоненты

#### 1. TemplateEditor
Компонент для создания и редактирования шаблонов рапортов (только для администраторов).

**Функции:**
- Создание новых шаблонов
- Редактирование существующих шаблонов
- Предпросмотр шаблона
- Валидация данных
- Привязка к департаментам

**Переменные в шаблонах:**
- Используется синтаксис `{{ПЕРЕМЕННАЯ}}`
- Автоматическое определение типа поля ввода
- Поддержка обязательных полей

#### 2. ReportFiller
Компонент для заполнения рапортов пользователями.

**Функции:**
- Динамическое создание полей ввода на основе шаблона
- Предпросмотр заполненного рапорта в реальном времени
- Валидация обязательных полей
- Копирование и скачивание рапорта
- Отправка на рассмотрение

#### 3. TemplateManager
Компонент для управления шаблонами (только для администраторов).

**Функции:**
- Просмотр всех шаблонов
- Фильтрация по департаментам
- Поиск по названию
- Статистика шаблонов
- Удаление/деактивация шаблонов

#### 4. TemplateBrowser
Компонент для просмотра доступных шаблонов пользователями.

**Функции:**
- Просмотр доступных шаблонов
- Фильтрация по департаментам
- Предпросмотр шаблонов
- Выбор шаблона для заполнения

### API Маршруты

#### Шаблоны рапортов (`/api/report-templates`)

- `GET /` - Получить все активные шаблоны
- `GET /:id` - Получить шаблон по ID
- `POST /` - Создать новый шаблон (admin/supervisor)
- `PUT /:id` - Обновить шаблон (создатель или admin)
- `DELETE /:id` - Удалить шаблон (admin)

#### Заполненные рапорты (`/api/filled-reports`)

- `GET /` - Получить рапорты пользователя
- `GET /:id` - Получить рапорт по ID
- `POST /` - Создать новый рапорт
- `PUT /:id` - Обновить рапорт
- `POST /:id/submit` - Отправить рапорт на рассмотрение
- `DELETE /:id` - Удалить рапорт (admin)
- `GET /stats/summary` - Статистика рапортов

## Права доступа

### Администраторы (`admin`)
- Полный доступ ко всем функциям
- Создание, редактирование, удаление шаблонов
- Просмотр всех рапортов
- Управление статусами рапортов

### Супервайзеры (`supervisor`)
- Создание и редактирование шаблонов
- Просмотр всех рапортов
- Управление статусами рапортов

### Участники (`member`)
- Просмотр доступных шаблонов
- Создание и заполнение рапортов
- Просмотр своих рапортов
- Отправка рапортов на рассмотрение

### Кандидаты (`candidate`)
- Просмотр общих шаблонов
- Создание и заполнение рапортов
- Просмотр своих рапортов

## Использование

### Для администраторов

1. **Создание шаблона:**
   - Перейти в раздел "Управление"
   - Нажать "Создать шаблон"
   - Заполнить название и тело шаблона
   - Использовать переменные в формате `{{ПЕРЕМЕННАЯ}}`
   - Сохранить шаблон

2. **Управление шаблонами:**
   - Просмотр всех шаблонов
   - Редактирование существующих
   - Деактивация/удаление шаблонов
   - Фильтрация по департаментам

### Для пользователей

1. **Выбор шаблона:**
   - Перейти в раздел "Шаблоны"
   - Просмотреть доступные шаблоны
   - Выбрать подходящий шаблон

2. **Заполнение рапорта:**
   - Заполнить все необходимые поля
   - Просмотреть предварительный результат
   - Отправить рапорт на рассмотрение

3. **Управление рапортами:**
   - Просмотр своих рапортов
   - Отслеживание статуса
   - Скачивание готовых рапортов

## Переменные в шаблонах

### Автоматическое определение типа поля

- **Дата:** поля, содержащие "дата"
- **Время:** поля, содержащие "время"
- **Текстовые области:** поля, содержащие "описание", "обстоятельства", "жалобы", "осмотр", "помощь", "диагноз"
- **Обычные поля:** все остальные

### Обязательные поля

Следующие поля автоматически помечаются как обязательные:
- `ИМЯ_ОФИЦЕРА`
- `ДОЛЖНОСТЬ`
- `ДАТА`
- `ВРЕМЯ`
- `МЕСТО_ПРОИСШЕСТВИЯ`
- `ФИО_ПАЦИЕНТА`
- `ВОЗРАСТ_ПАЦИЕНТА`
- `МАРКА_МОДЕЛЬ`
- `ГОС_НОМЕР`
- `ВОДИТЕЛЬ`
- `АДРЕС_ПОЖАРА`
- `РУКОВОДИТЕЛЬ_ТУШЕНИЯ`

## Статусы рапортов

- **draft** - Черновик (можно редактировать)
- **submitted** - Отправлен на рассмотрение
- **approved** - Одобрен
- **rejected** - Отклонен

## Безопасность

### RLS политики

- **report_templates:**
  - Чтение: все активные шаблоны
  - Создание: admin/supervisor
  - Обновление: создатель или admin
  - Удаление: admin

- **filled_reports:**
  - Чтение: свои рапорты или admin/supervisor
  - Создание: любой авторизованный пользователь
  - Обновление: свои черновики или admin/supervisor
  - Удаление: admin

### Валидация

- Проверка обязательных полей
- Валидация длины названия и тела шаблона
- Проверка существования шаблона при создании рапорта
- Контроль прав доступа на уровне API

## Миграция

Для установки системы выполните миграцию:

```bash
# Применить миграцию
psql -d your_database -f supabase/migrations/010_report_templates_system.sql
```

## Примеры шаблонов

### Рапорт об инциденте
```
РАПОРТ

Дата: {{ДАТА}}
Время: {{ВРЕМЯ}}

Я, {{ДОЛЖНОСТЬ}} {{ИМЯ_ОФИЦЕРА}}, докладываю о происшествии, зафиксированном по адресу: {{МЕСТО_ПРОИСШЕСТВИЯ}}.

ОПИСАНИЕ ИНЦИДЕНТА:
{{ОПИСАНИЕ_ИНЦИДЕНТА}}

УЧАСТНИКИ:
{{УЧАСТНИКИ}}

ПРИНЯТЫЕ МЕРЫ:
{{ПРИНЯТЫЕ_МЕРЫ}}

Подпись: ____________ ({{ИМЯ_ОФИЦЕРА}})
```

### Рапорт о ДТП
```
РАПОРТ О ДТП

Дата ДТП: {{ДАТА_ДТП}}
Время ДТП: {{ВРЕМЯ_ДТП}}
Место ДТП: {{МЕСТО_ДТП}}

Транспортное средство 1:
Марка/Модель: {{МАРКА_МОДЕЛЬ_ТС1}}
Гос. номер: {{ГОС_НОМЕР_ТС1}}
Водитель: {{ВОДИТЕЛЬ_ТС1}}

Транспортное средство 2:
Марка/Модель: {{МАРКА_МОДЕЛЬ_ТС2}}
Гос. номер: {{ГОС_НОМЕР_ТС2}}
Водитель: {{ВОДИТЕЛЬ_ТС2}}

Обстоятельства ДТП:
{{ОБСТОЯТЕЛЬСТВА_ДТП}}

Пострадавшие:
{{ПОСТРАДАВШИЕ}}

Офицер: {{ИМЯ_ОФИЦЕРА}}
Подразделение: {{ПОДРАЗДЕЛЕНИЕ}}
```

## Утилиты

### templateUtils.ts

Содержит функции для работы с шаблонами:

- `extractVariables(text)` - извлечение переменных из текста
- `renderPreview(templateBody, values)` - рендеринг предпросмотра
- `getInputType(variableName)` - определение типа поля ввода
- `isRequiredField(variableName)` - проверка обязательности поля
- `validateTemplate(template)` - валидация шаблона
- `generateReportTitle(templateTitle, fieldValues)` - генерация заголовка рапорта

## Заключение

Система рапортов предоставляет полный цикл работы с документацией:
1. Создание шаблонов администраторами
2. Выбор и заполнение шаблонов пользователями
3. Отправка на рассмотрение
4. Управление статусами и комментариями
5. Просмотр и скачивание готовых рапортов

Система интегрирована с существующей архитектурой приложения и использует те же принципы безопасности и авторизации. 