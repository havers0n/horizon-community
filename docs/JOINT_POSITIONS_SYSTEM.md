# Система Совмещений (Joint Positions System)

## Обзор

Система совмещений позволяет пользователям работать в нескольких департаментах одновременно. Это расширяет возможности участников сообщества и повышает гибкость управления персоналом.

## Основные возможности

### 1. Типы совмещений

- **Основное совмещение (Primary Joint)** - приоритетная работа в выбранном департаменте
- **Дополнительное совмещение (Secondary Joint)** - работа в свободное время от основного департамента

### 2. Бизнес-правила

- **Одно активное совмещение** - пользователь может иметь только одно совмещение одновременно
- **Согласие с документацией** - обязательно ознакомление с правилами департамента
- **Обоснование необходимости** - пользователь должен объяснить, зачем ему совмещение
- **Одобрение администрации** - все заявки проходят через администраторов
- **7-дневный кулдаун** - после отклонения заявки нельзя подать новую в течение 7 дней

### 3. Жизненный цикл совмещения

1. **Подача заявки** - пользователь заполняет форму с обоснованием
2. **Рассмотрение** - администрация изучает заявку
3. **Одобрение/Отклонение** - решение принимается с комментарием
4. **Активация** - при одобрении пользователь получает доступ к департаменту
5. **Снятие** - пользователь или администрация может снять совмещение

## Техническая реализация

### База данных

#### Таблица `joint_positions_history`
```sql
CREATE TABLE joint_positions_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    primary_department_id INTEGER NOT NULL REFERENCES departments(id),
    secondary_department_id INTEGER NOT NULL REFERENCES departments(id),
    status TEXT NOT NULL CHECK (status IN ('pending', 'active', 'inactive', 'removed')),
    start_date DATE NOT NULL,
    end_date DATE,
    reason TEXT NOT NULL,
    approved_by INTEGER REFERENCES users(id),
    approved_at TIMESTAMP,
    removed_by INTEGER REFERENCES users(id),
    removed_at TIMESTAMP,
    removal_reason TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### Функции базы данных

- `check_joint_position_limit(user_id)` - проверка лимита совмещений
- `get_active_joint_positions(user_id)` - получение активных совмещений
- `update_joint_positions_history_updated_at()` - автоматическое обновление timestamp

### API Эндпоинты

#### Пользовательские эндпоинты

- `GET /api/joint-positions` - получение активных совмещений пользователя
- `DELETE /api/joint-positions/:userId` - снятие совмещения

#### Административные эндпоинты

- `GET /api/admin/joint-applications` - получение всех заявок на совмещение
- `PUT /api/admin/joint-applications/:id` - обработка заявки (одобрение/отклонение)

### Компоненты интерфейса

#### JointModal.tsx
Форма подачи заявки на совмещение с валидацией и бизнес-логикой.

**Особенности:**
- Выбор типа совмещения (основное/дополнительное)
- Выбор департамента для совмещения
- Обоснование необходимости
- Согласие с документацией
- Проверка лимитов и существующих совмещений

#### JointPositions.tsx
Страница управления совмещениями с тремя вкладками:

1. **Активные совмещения** - просмотр и управление текущими совмещениями
2. **История заявок** - просмотр всех поданных заявок и их статусов
3. **Подать заявку** - быстрый доступ к форме подачи заявки

### Бизнес-логика

#### BusinessLogic.ts

**Методы для совмещений:**

- `checkJointApplicationLimit()` - проверка лимитов заявок
- `getActiveJointPositions()` - получение активных совмещений
- `processJointApplication()` - обработка заявки администрацией
- `removeJointPosition()` - снятие совмещения

**Проверки лимитов:**
- Максимум 1 активное совмещение
- Нет pending заявок
- 7-дневный кулдаун после отклонения

## Интеграция в систему

### Навигация
- Добавлен пункт "Совмещения" в главное меню
- Интегрирован в быстрые действия на дашборде

### Уведомления
- Уведомления об одобрении/отклонении заявок
- Уведомления о снятии совмещения

### Права доступа
- Пользователи: просмотр своих совмещений, подача заявок
- Супервайзеры/Администраторы: управление всеми заявками

## Безопасность

### RLS (Row Level Security)
- Пользователи видят только свои записи
- Администраторы имеют полный доступ
- Автоматическая проверка прав доступа

### Валидация данных
- Проверка типов данных на клиенте и сервере
- Валидация бизнес-правил
- Защита от SQL-инъекций

## Мониторинг и логирование

### Логирование операций
- Создание заявок
- Одобрение/отклонение
- Снятие совмещений
- Ошибки валидации

### Метрики
- Количество активных совмещений
- Статистика одобрений/отклонений
- Время обработки заявок

## Будущие улучшения

### Планируемые функции
1. **Автоматическое снятие** - по истечении срока
2. **Массовые операции** - для администраторов
3. **Уведомления о сроках** - напоминания о необходимости продления
4. **Аналитика** - детальная статистика по департаментам
5. **Интеграция с CAD** - отображение совмещений в системе

### Оптимизации
1. **Кэширование** - для часто запрашиваемых данных
2. **Пагинация** - для больших списков заявок
3. **Поиск и фильтрация** - в административной панели

## Устранение неполадок

### Частые проблемы

1. **"У вас уже есть активное совмещение"**
   - Решение: снять текущее совмещение перед подачей новой заявки

2. **"Лимит заявок исчерпан"**
   - Решение: дождаться окончания кулдауна (7 дней после отклонения)

3. **"Департамент не найден"**
   - Решение: проверить, что департамент существует и активен

### Логи ошибок
Все ошибки логируются в консоль сервера с префиксом `[JOINT]` для легкой идентификации.

## Заключение

Система совмещений предоставляет гибкий механизм для управления персоналом в различных департаментах. Она обеспечивает контроль качества через обязательное обоснование и одобрение администрации, при этом сохраняя простоту использования для конечных пользователей. 