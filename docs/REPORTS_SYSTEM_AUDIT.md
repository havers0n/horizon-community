# АУДИТ СИСТЕМЫ РАПОРТОВ

## Обзор системы

Система рапортов полностью интегрирована в основной проект и основана на логике из "единая-система-учета-рапортов". Система поддерживает создание шаблонов рапортов администраторами и заполнение рапортов пользователями на основе этих шаблонов.

## Архитектура системы

### 1. База данных

#### Таблицы:
- **report_templates** - шаблоны рапортов
- **filled_reports** - заполненные рапорты

#### Схема report_templates:
```sql
CREATE TABLE report_templates (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    body TEXT NOT NULL,
    department_id INTEGER REFERENCES departments(id),
    created_by INTEGER NOT NULL REFERENCES users(id),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);
```

#### Схема filled_reports:
```sql
CREATE TABLE filled_reports (
    id SERIAL PRIMARY KEY,
    template_id INTEGER NOT NULL REFERENCES report_templates(id),
    author_id INTEGER NOT NULL REFERENCES users(id),
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'approved', 'rejected')),
    supervisor_comment TEXT,
    submitted_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);
```

### 2. API маршруты

#### /api/report-templates
- `GET /` - получить все активные шаблоны
- `GET /:id` - получить шаблон по ID
- `POST /` - создать новый шаблон (только admin/supervisor)
- `PUT /:id` - обновить шаблон (создатель или admin)
- `DELETE /:id` - удалить шаблон (только admin)

#### /api/filled-reports
- `GET /` - получить заполненные рапорты пользователя
- `GET /:id` - получить рапорт по ID
- `POST /` - создать новый рапорт
- `PUT /:id` - обновить рапорт
- `POST /:id/submit` - отправить рапорт на рассмотрение

### 3. Компоненты React

#### Основные компоненты:
- **Reports.tsx** - главная страница рапортов с табами
- **TemplateEditor.tsx** - редактор шаблонов для администраторов
- **ReportFiller.tsx** - заполнение рапортов пользователями
- **TemplateManager.tsx** - управление шаблонами для администраторов
- **TemplateBrowser.tsx** - просмотр доступных шаблонов

#### Утилиты:
- **templateUtils.ts** - функции для работы с шаблонами

## Функциональность

### Для администраторов (admin/supervisor):

1. **Создание шаблонов**
   - Название шаблона
   - Тело шаблона с переменными в формате {{ПЕРЕМЕННАЯ}}
   - Привязка к департаменту (опционально)

2. **Редактирование шаблонов**
   - Изменение названия и тела
   - Предпросмотр с выделением переменных
   - Валидация шаблона

3. **Управление шаблонами**
   - Просмотр всех шаблонов
   - Фильтрация по департаментам
   - Поиск по названию
   - Активация/деактивация
   - Удаление (с проверкой на использование)

### Для пользователей:

1. **Просмотр шаблонов**
   - Список доступных шаблонов
   - Фильтрация по департаментам
   - Предпросмотр шаблона

2. **Заполнение рапортов**
   - Динамическое создание форм на основе переменных
   - Автоматическое определение типов полей (text, date, time, textarea)
   - Предпросмотр заполненного рапорта
   - Копирование в буфер обмена
   - Скачивание в файл
   - Отправка на рассмотрение

3. **Управление рапортами**
   - Просмотр своих рапортов
   - Отслеживание статуса (draft, submitted, approved, rejected)
   - Просмотр комментариев руководителя

## Безопасность

### Row Level Security (RLS):
- Пользователи видят только свои рапорты
- Администраторы видят все рапорты
- Шаблоны доступны всем активным пользователям
- Создание/редактирование шаблонов только для admin/supervisor

### Валидация:
- Проверка обязательных полей
- Валидация шаблонов (название, тело)
- Проверка прав доступа на уровне API

## Интеграция с существующей системой

### Аутентификация:
- Использует существующую систему аутентификации
- Интегрируется с AuthContext

### Роли пользователей:
- **admin** - полный доступ ко всем функциям
- **supervisor** - может создавать/редактировать шаблоны, просматривать все рапорты
- **member** - может заполнять рапорты, просматривать свои
- **candidate** - ограниченный доступ

### Департаменты:
- Шаблоны могут быть привязаны к конкретным департаментам
- Пользователи видят шаблоны своего департамента + общие

## Начальные шаблоны

Система включает 4 предустановленных шаблона:
1. Рапорт об инциденте
2. Рапорт о дорожно-транспортном происшествии
3. Рапорт о пожаре
4. Рапорт о медицинском событии

## Технические особенности

### Обработка переменных:
- Регулярные выражения для извлечения переменных из шаблонов
- Автоматическое определение типов полей
- Поддержка обязательных полей

### UI/UX:
- Адаптивный дизайн
- Темная/светлая тема
- Toast уведомления
- Модальные окна для предпросмотра
- Drag & drop для файлов (потенциально)

### Производительность:
- Индексы на ключевых полях
- Пагинация для больших списков
- Кэширование запросов через React Query

## Статус реализации

✅ **Полностью реализовано:**
- База данных и миграции
- API маршруты
- React компоненты
- Система безопасности
- Начальные шаблоны
- Интеграция с существующей системой

✅ **Готово к использованию:**
- Создание и редактирование шаблонов
- Заполнение рапортов
- Управление рапортами
- Система ролей и прав доступа

## Рекомендации по улучшению

1. **Дополнительные функции:**
   - Экспорт в PDF
   - Массовая отправка рапортов
   - Шаблоны с изображениями
   - Автоматическое заполнение полей

2. **Улучшения UI:**
   - Drag & drop для файлов
   - Rich text editor для шаблонов
   - Предпросмотр в реальном времени

3. **Аналитика:**
   - Статистика по рапортам
   - Отчеты по департаментам
   - Анализ популярных шаблонов

## Заключение

Система рапортов полностью функциональна и готова к использованию. Она успешно интегрирована в основной проект и следует архитектурным принципам существующей системы. Все основные функции реализованы, система безопасна и масштабируема. 