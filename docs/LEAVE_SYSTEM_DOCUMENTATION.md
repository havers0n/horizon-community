# Система Отпусков (Leave Management System)

## Обзор

Полная система управления отпусками предоставляет пользователям возможность подавать заявки на различные типы отпусков, а администраторам - управлять этими заявками и отслеживать статистику использования отпусков.

## Основные возможности

### 1. Типы отпусков

- **Отпуск (Vacation)** - плановый отдых и восстановление
- **Больничный (Sick)** - медицинские заболевания и восстановление
- **Личный (Personal)** - личные дела и встречи
- **Экстренный (Emergency)** - неожиданные срочные ситуации
- **Медицинский (Medical)** - длительное медицинское лечение или операции
- **Декретный (Maternity/Paternity)** - рождение ребенка или усыновление
- **Траурный (Bereavement)** - потеря члена семьи или близкого друга

### 2. Бизнес-правила

#### Ограничения подачи заявок:
- **Максимум 2 заявки на отпуск в месяц**
- **Минимальный срок подачи для отпуска: 2 недели**
- **Проверка пересечений** с существующими отпусками
- **Максимальная продолжительность** для каждого типа отпуска

#### Максимальная продолжительность по типам:
- Отпуск: 30 дней
- Больничный: 14 дней
- Личный: 7 дней
- Экстренный: 3 дня
- Медицинский: 90 дней
- Декретный: 365 дней
- Траурный: 7 дней

#### Автоматизация:
- **Автоматическая выдача роли "Отпуск"** при начале отпуска
- **Автоматическое снятие роли** при завершении отпуска
- **Обработка частичных дней** с учетом рабочего времени
- **Уведомления** о приближающихся отпусках

### 3. Пользовательский интерфейс

#### Страница управления отпусками (`/leave-management`)

**Вкладки:**
1. **Календарь** - визуализация отпусков по месяцам
2. **Статистика** - обзор использования отпусков за год
3. **История** - все заявки пользователя с статусами
4. **Подать заявку** - форма подачи новой заявки

**Функции календаря:**
- Навигация по месяцам
- Отображение отпусков по дням
- Цветовая кодировка по типам отпусков
- Интерактивные элементы

**Статистика:**
- Использовано дней в году
- Осталось дней
- Активный отпуск (если есть)
- Предстоящие отпуска
- Детальная статистика по типам

#### Модальное окно подачи заявки

**Поля формы:**
- Тип отпуска (с описанием)
- Дата начала и окончания
- Причина (минимум 5 символов)
- Контакт для экстренной связи
- Телефон экстренной связи
- Договоренности о покрытии обязанностей
- Частичный день (опционально)
- Время начала и окончания (для частичных дней)
- Дополнительные заметки

**Валидация:**
- Проверка дат (конец после начала)
- Проверка лимитов подачи
- Проверка пересечений
- Проверка минимального срока подачи
- Проверка максимальной продолжительности

### 4. Административный интерфейс

#### Страница административного управления (`/admin-leave-management`)

**Вкладки:**
1. **Заявки** - таблица всех заявок с возможностью рассмотрения
2. **Статистика** - общая статистика по системе
3. **По департаментам** - детальная статистика по департаментам

**Функции таблицы заявок:**
- Сортировка по статусу, дате, сотруднику
- Фильтрация по департаментам
- Просмотр деталей заявки
- Одобрение/отклонение с комментариями
- Статистические бейджи

**Функции рассмотрения:**
- Просмотр полной информации о заявке
- Добавление комментария администратора
- Одобрение или отклонение заявки
- Уведомления пользователю о решении

**Статистика по департаментам:**
- Общее количество заявок
- Количество одобренных/отклоненных/в ожидании
- Общее количество дней отпуска
- Детализация по типам отпусков

### 5. API Эндпоинты

#### Пользовательские эндпоинты:
- `GET /api/leave-stats` - статистика отпусков пользователя
- `POST /api/applications` - подача заявки на отпуск

#### Административные эндпоинты:
- `GET /api/admin/leave-applications` - все заявки на отпуск
- `GET /api/admin/leave-stats` - общая статистика отпусков
- `PUT /api/admin/applications/:id` - обновление статуса заявки

#### Планировщик:
- `POST /api/scheduler/process-leaves` - ручная обработка отпусков
- `GET /api/scheduler/status` - статус планировщика

### 6. Бизнес-логика

#### Проверки при подаче заявки:
```typescript
// Проверка лимитов подачи
checkLeaveApplicationLimit(applications, currentMonth, userId, leaveData)

// Проверка пересечений
checkLeaveOverlap(userId, leaveData)

// Проверка минимального срока подачи
checkMinimumAdvanceNotice(startDate)

// Проверка максимальной продолжительности
checkMaximumLeaveDuration(leaveData)
```

#### Автоматическая обработка:
```typescript
// Обработка отпусков каждый день в 9:00
processLeaveApplications()

// Выдача роли "Отпуск"
grantLeaveRole(leaveApp)

// Снятие роли "Отпуск"
revokeLeaveRole(leaveApp)

// Обработка частичных дней
processPartialDayLeave(leaveApp, now)

// Уведомления о приближающихся отпусках
checkUpcomingLeaveNotifications(leaveApp, now)
```

### 7. База данных

#### Основные таблицы:
- `applications` - заявки на отпуск
- `users` - пользователи с полем `status` для роли "Отпуск"
- `notifications` - уведомления о отпусках

#### Схема данных заявки:
```typescript
{
  id: number;
  type: 'leave';
  status: 'pending' | 'approved' | 'rejected' | 'closed';
  data: {
    leaveType: string;
    startDate: string;
    endDate: string;
    reason: string;
    emergencyContact?: string;
    emergencyPhone?: string;
    coverageArrangements?: string;
    isPartialDay: boolean;
    startTime?: string;
    endTime?: string;
    additionalNotes?: string;
    totalDays: number;
  };
  authorId: number;
  createdAt: string;
  updatedAt: string;
  reviewComment?: string;
}
```

### 8. Уведомления

#### Типы уведомлений:
- **Начало отпуска** - "Ваш отпуск начался. Роль 'Отпуск' выдана."
- **Завершение отпуска** - "Ваш отпуск завершен. Роль 'Отпуск' снята."
- **Приближающийся отпуск** - напоминание за 3 дня до начала
- **Решение по заявке** - уведомление об одобрении/отклонении

### 9. Интеграция с системой

#### Навигация:
- Добавлена вкладка "Отпуска" в основное меню
- Административная вкладка "Управление отпусками" для супервайзеров/админов

#### Дашборд:
- Быстрые действия для подачи заявки на отпуск
- Отображение активного отпуска
- Счетчик предстоящих отпусков

#### Роли и права:
- Все пользователи могут подавать заявки
- Супервайзеры и администраторы могут рассматривать заявки
- Администраторы могут управлять планировщиком

### 10. Безопасность

#### Проверки доступа:
- Аутентификация для всех эндпоинтов
- Проверка ролей для административных функций
- Валидация данных на клиенте и сервере

#### Защита данных:
- Проверка принадлежности заявки пользователю
- Логирование всех административных действий
- Безопасная передача данных через HTTPS

### 11. Производительность

#### Оптимизации:
- Кэширование статистики через React Query
- Пагинация для больших списков заявок
- Индексирование базы данных по датам и статусам

#### Мониторинг:
- Логирование ошибок обработки отпусков
- Метрики производительности API
- Отслеживание времени отклика интерфейса

### 12. Тестирование

#### Тестовые сценарии:
- Подача заявки с различными типами отпусков
- Проверка бизнес-правил и ограничений
- Тестирование автоматической обработки
- Проверка административных функций

#### Автоматизированные тесты:
- Unit тесты для бизнес-логики
- Integration тесты для API
- E2E тесты для пользовательских сценариев

---

## Заключение

Система отпусков предоставляет полный цикл управления отпусками от подачи заявки до автоматической обработки, включая административные инструменты для контроля и аналитики. Система интегрирована с общей архитектурой приложения и следует установленным стандартам безопасности и производительности. 