# As-Is Documentation: CAD System
*Документация текущего состояния системы управления департаментами для RP-серверов*

**Дата:** 01 января 2025  
**Версия:** 1.0  
**Статус:** Рабочий прототип

---

## 1. Обзор системы

### 1.1 Описание
CAD System - это веб-приложение для управления департаментами в ролевых играх (особенно GTA RP серверах). Система предоставляет функции для управления пользователями, подачи заявок, обработки жалоб и работы службы поддержки.

### 1.2 Цель системы
- Автоматизация процессов управления RP-организациями
- Централизованное управление участниками департаментов
- Обработка заявок на повышение, перевод, отпуск
- Система поддержки и жалоб
- Административная панель для руководства

---

## 2. Техническая архитектура

### 2.1 Стек технологий

**Frontend:**
- React 18 с TypeScript
- Vite (сборщик)
- Wouter (роутинг)
- TanStack Query (управление состоянием сервера)
- shadcn/ui + Radix UI (компоненты интерфейса)
- Tailwind CSS (стилизация)
- React Hook Form + Zod (формы и валидация)
- Lucide React (иконки)

**Backend:**
- Node.js + Express.js
- TypeScript
- JWT аутентификация
- bcrypt (хеширование паролей)
- In-Memory Storage (временное решение)

**Инструменты разработки:**
- ESBuild (продакшн сборка)
- tsx (TypeScript выполнение)
- Drizzle ORM (схема БД)

### 2.2 Архитектурные решения

**Монорепозиторий:**
- `/client` - React приложение
- `/server` - Express API
- `/shared` - общие типы и схемы

**Паттерны:**
- RESTful API
- Component-based архитектура
- Separation of Concerns
- Type-safe разработка

---

## 3. Структура базы данных

### 3.1 Основные сущности

**Users (Пользователи):**
```typescript
{
  id: number (PK)
  username: string (unique)
  email: string (unique) 
  passwordHash: string
  role: 'candidate' | 'member' | 'supervisor' | 'admin'
  status: 'active' | 'on_leave' | 'banned'
  departmentId: number (FK)
  secondaryDepartmentId: number (FK, nullable)
  rank: string
  division: string
  qualifications: string[]
  gameWarnings: number
  adminWarnings: number
  createdAt: Date
}
```

**Departments (Департаменты):**
```typescript
{
  id: number (PK)
  name: string
  fullName: string
  logoUrl: string
  description: string
  gallery: string[]
}
```

**Applications (Заявки):**
```typescript
{
  id: number (PK)
  authorId: number (FK)
  type: 'entry' | 'promotion' | 'qualification' | 'transfer_dept' | 'transfer_div' | 'leave' | 'joint_primary' | 'joint_secondary' | 'joint_remove'
  status: 'pending' | 'approved' | 'rejected' | 'closed'
  data: JSON (детали заявки)
  result: JSON (результаты тестов)
  reviewerId: number (FK)
  reviewComment: string
  createdAt: Date
  updatedAt: Date
}
```

**Support Tickets (Тикеты поддержки):**
```typescript
{
  id: number (PK)
  authorId: number (FK)
  status: 'open' | 'closed'
  handlerId: number (FK)
  messages: JSON[]
  createdAt: Date
}
```

**Complaints (Жалобы):**
```typescript
{
  id: number (PK)
  authorId: number (FK)
  status: 'pending' | 'in_progress' | 'resolved' | 'declined'
  incidentDate: Date
  incidentType: 'game' | 'admin'
  participants: string
  description: string
  evidenceUrl: string
  createdAt: Date
}
```

**Reports (Рапорты):**
```typescript
{
  id: number (PK)
  authorId: number (FK)
  status: 'pending' | 'approved' | 'rejected'
  fileUrl: string
  supervisorComment: string
  createdAt: Date
}
```

**Notifications (Уведомления):**
```typescript
{
  id: number (PK)
  recipientId: number (FK)
  content: string
  link: string
  isRead: boolean
  createdAt: Date
}
```

**Tests (Тесты):**
```typescript
{
  id: number (PK)
  title: string
  relatedTo: JSON
  durationMinutes: number
  questions: JSON[]
}
```

### 3.2 Предустановленные данные

**Департаменты:**
- LSPD (Horizon Police Department)
- LSFD (Horizon Fire Department)  
- EMS (Emergency Medical Services)
- BCSO (Blaine County Sheriff's Office)

**Тестовые пользователи:**
- admin@cadsystem.com / admin123 (admin)
- supervisor@cadsystem.com / super123 (supervisor)
- member@cadsystem.com / member123 (member)
- candidate@cadsystem.com / candidate123 (candidate)

---

## 4. API Спецификация

### 4.1 Аутентификация

**POST /api/auth/register**
- Регистрация нового пользователя
- Возвращает: user, token

**POST /api/auth/login**  
- Вход в систему
- Возвращает: user, token

**GET /api/auth/me**
- Получение данных текущего пользователя
- Требует: JWT токен

### 4.2 Публичные эндпоинты

**GET /api/departments**
- Список всех департаментов

**GET /api/departments/:id**
- Детальная информация о департаменте

### 4.3 Защищённые эндпоинты

**Заявки:**
- GET /api/applications - список заявок пользователя
- POST /api/applications - создание заявки

**Рапорты:**
- GET /api/reports - список рапортов пользователя

**Уведомления:**
- GET /api/notifications - уведомления пользователя
- PUT /api/notifications/:id/read - отметить как прочитанное

**Жалобы:**
- POST /api/complaints - подача жалобы

**Поддержка:**
- GET /api/tickets - тикеты пользователя
- POST /api/tickets - создание тикета
- GET /api/tickets/:id - детали тикета

### 4.4 Административные эндпоинты

**Управление заявками:**
- GET /api/admin/applications - все заявки с фильтрацией
- PUT /api/admin/applications/:id - обновление статуса заявки

**Управление пользователями:**
- GET /api/admin/users - список всех пользователей
- PUT /api/admin/users/:id - обновление данных пользователя

**Поддержка:**
- GET /api/admin/tickets - все тикеты поддержки

**Статистика:**
- GET /api/stats - общая статистика системы

---

## 5. Пользовательские роли и права доступа

### 5.1 Candidate (Кандидат)
**Доступные функции:**
- Просмотр департаментов
- Подача заявок на вступление
- Просмотр своих заявок
- Создание тикетов поддержки
- Подача жалоб

**Ограничения:**
- Нет доступа к админ-панели
- Ограниченный набор типов заявок

### 5.2 Member (Участник)
**Доступные функции:**
- Все функции кандидата
- Подача заявок на повышение
- Заявки на перевод между департаментами
- Заявки на отпуск
- Заявки на квалификации

**Ограничения:**
- Нет административных прав
- Не может рассматривать заявки других

### 5.3 Supervisor (Супервайзер)
**Доступные функции:**
- Все функции участника
- Доступ к административной панели
- Рассмотрение и одобрение/отклонение заявок
- Просмотр статистики
- Управление пользователями
- Ответы в тикетах поддержки

**Ограничения:**
- Ограниченные права по сравнению с администратором

### 5.4 Admin (Администратор)
**Доступные функции:**
- Полный доступ ко всем функциям системы
- Управление департаментами
- Полное управление пользователями
- Системная статистика и аналитика
- Настройка ролей

---

## 6. Пользовательский интерфейс

### 6.1 Страницы приложения

**Публичные страницы:**
- `/login` - Вход в систему
- `/register` - Регистрация

**Защищённые страницы:**
- `/dashboard` - Главная панель с обзором
- `/departments` - Список департаментов
- `/applications` - Мои заявки
- `/support` - Служба поддержки
- `/admin` - Административная панель (supervisor/admin)

### 6.2 Компоненты интерфейса

**Основные компоненты:**
- `Layout` - Общий макет с навигацией
- `ProtectedRoute` - Защита приватных страниц
- `ApplicationModal` - Модальное окно создания заявки
- `ComplaintModal` - Модальное окно подачи жалобы
- `SupportModal` - Модальное окно создания тикета

**UI компоненты (shadcn/ui):**
- Формы с валидацией
- Таблицы данных
- Модальные окна
- Карточки информации
- Навигационное меню
- Уведомления (toast)

### 6.3 Особенности UX

**Адаптивный дизайн:**
- Поддержка мобильных устройств
- Responsive grid система

**Интерактивность:**
- Реальное время обновлений
- Индикаторы загрузки
- Валидация форм в реальном времени

**Уведомления:**
- Счётчик непрочитанных уведомлений
- Toast сообщения для обратной связи

---

## 7. Реализованная функциональность

### 7.1 Система аутентификации
✅ **Полностью реализовано:**
- Регистрация пользователей
- Вход/выход из системы
- JWT токены
- Защита маршрутов
- Хранение сессии в localStorage

### 7.2 Управление заявками
✅ **Полностью реализовано:**
- Создание заявок разных типов
- Просмотр списка заявок
- Статусы заявок (pending, approved, rejected, closed)
- Комментарии рецензентов
- Уведомления при смене статуса

### 7.3 Административная панель
✅ **Полностью реализовано:**
- Просмотр всех заявок
- Одобрение/отклонение заявок
- Список пользователей
- Системная статистика
- Контроль доступа по ролям

### 7.4 Система поддержки
✅ **Базовая реализация:**
- Создание тикетов поддержки
- Просмотр списка тикетов
- Статусы тикетов (open, closed)

### 7.5 Система жалоб
✅ **Полностью реализовано:**
- Подача жалоб
- Типы инцидентов (game, admin)
- Загрузка доказательств (URL)
- Участники инцидента

### 7.6 Департаменты
✅ **Полностью реализовано:**
- Просмотр списка департаментов
- Детальная информация
- Логотипы и галереи
- Предустановленные департаменты

### 7.7 Уведомления
✅ **Полностью реализовано:**
- Автоматические уведомления
- Отметка как прочитанные
- Счётчик в интерфейсе

---

## 8. Ограничения и технические долги

### 8.1 Критические ограничения

**Хранение данных:**
- ❌ In-memory storage (данные теряются при перезапуске)
- ❌ Нет персистентности
- ❌ Не подходит для продакшн

**Файловая система:**
- ❌ Нет загрузки файлов
- ❌ Только URL ссылки на доказательства
- ❌ Нет валидации медиа-контента

### 8.2 Функциональные пробелы

**Система тестирования:**
- ❌ Не реализована система тестов
- ❌ Нет интерфейса прохождения тестов
- ❌ Отсутствует таймер и защита от читерства

**Система сообщений:**
- ❌ Нет чата в тикетах поддержки
- ❌ Отсутствует real-time обмен сообщениями
- ❌ Нет истории сообщений

**Система рапортов:**
- ❌ Интерфейс не реализован
- ❌ Нет загрузки файлов рапортов
- ❌ Отсутствует процесс рассмотрения

### 8.3 Технические проблемы

**Безопасность:**
- ⚠️ JWT секрет хардкоден
- ⚠️ Нет rate limiting
- ⚠️ Отсутствует CSRF защита

**Производительность:**
- ⚠️ Нет кеширования
- ⚠️ Отсутствует пагинация
- ⚠️ Все данные загружаются сразу

**Мониторинг:**
- ❌ Нет логирования ошибок
- ❌ Отсутствует аналитика
- ❌ Нет метрик производительности

### 8.4 UX недостатки

**Навигация:**
- ⚠️ Нет хлебных крошек
- ⚠️ Отсутствует поиск
- ⚠️ Нет фильтрации списков

**Обратная связь:**
- ⚠️ Ограниченные сообщения об ошибках
- ⚠️ Нет справочной системы
- ⚠️ Отсутствуют подсказки

---

## 9. Производительность

### 9.1 Текущие метрики
- **Время запуска:** ~3-5 секунд
- **Время ответа API:** <100ms (in-memory)
- **Размер бандла:** ~2MB (не оптимизирован)
- **Поддерживаемые браузеры:** Современные (ES2020+)

### 9.2 Узкие места
- Отсутствие lazy loading компонентов
- Загрузка всех зависимостей сразу
- Нет оптимизации изображений
- Синхронная обработка запросов

---

## 10. Безопасность

### 10.1 Реализованные меры
✅ **Аутентификация:**
- JWT токены
- Хеширование паролей (bcrypt)
- Проверка ролей на API уровне

✅ **Валидация:**
- Zod схемы для входных данных
- TypeScript проверки типов
- Санитизация пользовательского ввода

### 10.2 Уязвимости
❌ **Критические:**
- Секретный ключ в коде
- Отсутствие HTTPS
- Нет защиты от брутфорс атак

⚠️ **Средние:**
- XSS через пользовательский контент
- Отсутствие CSP заголовков
- Нет аудита безопасности

---

## 11. Развёртывание

### 11.1 Текущий процесс
**Разработка:**
```bash
npm run dev  # Запуск dev серверов
```

**Сборка:**
```bash
npm run build  # Сборка для продакшн
```

### 11.2 Требования к окружению
- Node.js 20+
- npm или yarn
- Современный браузер

### 11.3 Переменные окружения
```env
NODE_ENV=development|production
JWT_SECRET=your-secret-key
DATABASE_URL=postgresql://... (не используется)
```

---

## 12. Заключение

### 12.1 Готовность к использованию
**Статус:** Функциональный прототип (70% готовности)

**Можно использовать для:**
- Демонстрации концепции
- Локального тестирования
- Разработки UI/UX
- Обучения команды

**Не готово для:**
- Продакшн развёртывания
- Хранения реальных данных
- Высоких нагрузок
- Коммерческого использования

### 12.2 Критический путь к продакшн
1. **Интеграция с PostgreSQL** (высокий приоритет)
2. **Система загрузки файлов** (высокий приоритет)
3. **Реализация тестирования** (средний приоритет)
4. **Система сообщений** (средний приоритет)
5. **Безопасность и мониторинг** (высокий приоритет)

### 12.3 Рекомендации по доработке
- Перейти на PostgreSQL + Drizzle ORM
- Добавить файловое хранилище (S3/MinIO)
- Реализовать WebSocket для real-time
- Внедрить систему логирования
- Добавить unit и integration тесты
- Оптимизировать производительность фронтенда

---

*Документ создан: 01.01.2025*  
*Автор: CAD System Development Team*  
*Версия: 1.0*