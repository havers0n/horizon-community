# Система форума

## Обзор

Система форума предоставляет полнофункциональную платформу для общения участников игрового сообщества. Форум организован по департаментам и включает в себя все необходимые функции современного форума.

## Архитектура

### База данных

Система форума использует следующие таблицы:

#### `forum_categories` - Категории форума
- `id` - Уникальный идентификатор
- `name` - Название категории
- `description` - Описание категории
- `department_id` - Связь с департаментом (опционально)
- `icon` - Иконка категории
- `color` - Цвет категории
- `order_index` - Порядок отображения
- `is_active` - Активна ли категория
- `topics_count` - Количество тем
- `posts_count` - Количество сообщений
- `last_activity` - Последняя активность

#### `forum_topics` - Темы форума
- `id` - Уникальный идентификатор
- `category_id` - Связь с категорией
- `author_id` - Автор темы
- `title` - Заголовок темы
- `content` - Содержимое темы
- `status` - Статус (open, closed, pinned, locked)
- `is_pinned` - Закреплена ли тема
- `is_locked` - Заблокирована ли тема
- `views_count` - Количество просмотров
- `replies_count` - Количество ответов
- `tags` - Теги темы
- `created_at` - Дата создания
- `updated_at` - Дата обновления

#### `forum_posts` - Сообщения
- `id` - Уникальный идентификатор
- `topic_id` - Связь с темой
- `author_id` - Автор сообщения
- `parent_id` - Родительское сообщение (для цитирования)
- `content` - Содержимое сообщения
- `is_edited` - Было ли отредактировано
- `edited_at` - Дата редактирования
- `edited_by` - Кто редактировал
- `reactions_count` - Количество реакций
- `created_at` - Дата создания
- `updated_at` - Дата обновления

#### `forum_reactions` - Реакции на сообщения
- `id` - Уникальный идентификатор
- `post_id` - Связь с сообщением
- `user_id` - Пользователь
- `reaction_type` - Тип реакции (like, dislike, heart, etc.)
- `created_at` - Дата создания

#### `forum_subscriptions` - Подписки на темы
- `id` - Уникальный идентификатор
- `user_id` - Пользователь
- `topic_id` - Связь с темой
- `is_email_notification` - Email уведомления
- `created_at` - Дата создания

#### `forum_views` - Просмотры тем
- `id` - Уникальный идентификатор
- `topic_id` - Связь с темой
- `user_id` - Пользователь (опционально)
- `ip_address` - IP адрес
- `user_agent` - User Agent
- `viewed_at` - Дата просмотра

#### `forum_stats` - Статистика форума
- `id` - Уникальный идентификатор
- `total_topics` - Общее количество тем
- `total_posts` - Общее количество сообщений
- `total_members` - Общее количество участников
- `online_now` - Онлайн сейчас
- `last_update` - Последнее обновление

### API Endpoints

#### Статистика
- `GET /api/forum/stats` - Получение статистики форума

#### Категории
- `GET /api/forum/categories` - Получение всех категорий
- `GET /api/forum/categories/:categoryId/topics` - Получение тем в категории

#### Темы
- `POST /api/forum/topics` - Создание новой темы
- `GET /api/forum/topics/:topicId` - Получение темы с сообщениями

#### Сообщения
- `POST /api/forum/topics/:topicId/posts` - Создание сообщения
- `PUT /api/forum/posts/:postId` - Редактирование сообщения
- `DELETE /api/forum/posts/:postId` - Удаление сообщения

#### Реакции
- `POST /api/forum/posts/:postId/reactions` - Добавление/удаление реакции

#### Подписки
- `POST /api/forum/topics/:topicId/subscribe` - Подписка/отписка от темы

#### Поиск
- `GET /api/forum/search` - Поиск по форуму
- `GET /api/forum/recent` - Последние активные темы

## Функциональность

### Основные возможности

1. **Просмотр категорий** - Структурированный просмотр по департаментам
2. **Создание тем** - Авторизованные пользователи могут создавать темы
3. **Ответы в темах** - Система ответов с поддержкой цитирования
4. **Реакции** - Лайки, дизлайки и другие реакции на сообщения
5. **Подписки** - Подписка на интересующие темы
6. **Поиск** - Полнотекстовый поиск по темам и сообщениям
7. **Модерация** - Закрепление, блокировка тем (для админов)
8. **Статистика** - Просмотры, ответы, активность

### Права доступа

- **Гости** - Только просмотр
- **Авторизованные пользователи** - Создание тем и сообщений
- **Авторы** - Редактирование и удаление своих сообщений
- **Админы/Супервайзеры** - Полная модерация

### Безопасность

- Rate limiting для предотвращения спама
- RLS политики для контроля доступа
- Валидация входных данных
- Защита от XSS и SQL инъекций

## Установка и настройка

### 1. Применение миграции

```bash
npm run forum:migrate
```

### 2. Проверка установки

После применения миграции проверьте:

1. Создание таблиц в базе данных
2. Наличие начальных категорий
3. Работу API endpoints
4. Доступность страницы форума по адресу `/forum`

### 3. Настройка категорий

Категории создаются автоматически для каждого департамента:

- Полицейский департамент
- Гражданский департамент
- Диспетчерский департамент
- Пожарный департамент
- Медицинский департамент
- Общие мануалы и гайды

## Использование

### Для пользователей

1. **Просмотр форума** - Перейдите на `/forum`
2. **Выбор категории** - Кликните на интересующую категорию
3. **Создание темы** - Нажмите "Создать тему" в категории
4. **Ответы** - Используйте форму ответа в теме
5. **Поиск** - Используйте поиск в верхней панели

### Для администраторов

1. **Модерация** - Используйте выпадающее меню в сообщениях
2. **Управление темами** - Закрепление, блокировка тем
3. **Статистика** - Просмотр статистики форума

## Технические детали

### Триггеры базы данных

Система использует автоматические триггеры для:

- Обновления счетчиков тем и сообщений
- Обновления статистики категорий
- Подсчета реакций

### Индексы

Оптимизированные индексы для:

- Поиска по категориям
- Сортировки по дате/популярности
- Фильтрации по статусу
- Быстрого доступа к сообщениям

### Кэширование

- React Query для кэширования данных
- Автоматическая инвалидация при изменениях
- Оптимистичные обновления

## Расширение функционала

### Возможные улучшения

1. **Уведомления** - Email и push уведомления
2. **Файлы** - Загрузка изображений и документов
3. **Голосование** - Система голосования за темы
4. **Теги** - Расширенная система тегов
5. **Модерация** - Система модераторов
6. **Аналитика** - Детальная аналитика активности

### Добавление новых функций

1. Создайте новые таблицы в миграции
2. Добавьте API endpoints
3. Обновите схемы TypeScript
4. Создайте React компоненты
5. Добавьте тесты

## Troubleshooting

### Частые проблемы

1. **Ошибки миграции** - Проверьте права доступа к базе данных
2. **Проблемы с RLS** - Убедитесь в правильности политик
3. **Ошибки API** - Проверьте логи сервера
4. **Проблемы с UI** - Проверьте консоль браузера

### Логирование

Система ведет подробные логи для:

- Создания/редактирования тем и сообщений
- Ошибок API
- Действий модерации
- Проблем с производительностью

## Производительность

### Оптимизации

1. **Пагинация** - Ограничение количества записей
2. **Индексы** - Оптимизированные запросы
3. **Кэширование** - React Query
4. **Lazy loading** - Загрузка по требованию

### Мониторинг

Рекомендуется мониторить:

- Время ответа API
- Количество запросов к базе данных
- Использование памяти
- Активность пользователей

## Заключение

Система форума предоставляет полнофункциональную платформу для общения участников сообщества. Архитектура позволяет легко расширять функционал и поддерживать высокую производительность. 