#!/bin/bash

echo "üîß –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° VITE"
echo "============================================="

cd /var/www/app

echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
pm2 delete roleplayidentity 2>/dev/null || echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–æ–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞–ª—Å—è
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
pm2 show roleplayidentity 2>/dev/null | grep "script" || echo "PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–±–æ—Ä–∫–∏
echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–±–æ—Ä–∫–∏..."
rm -f dist/index.js
rm -f dist/production-entry.js

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ server.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "dist/server.js" ]; then
    echo "‚ùå dist/server.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üí° –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏..."
    npm ci
    
    # –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä (–±–µ–∑ frontend)
    echo "üî® –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä..."
    npm run build:server-only
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    npm ci --production
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ server.js —Å–æ–∑–¥–∞–Ω
if [ ! -f "dist/server.js" ]; then
    echo "‚ùå dist/server.js –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏!"
    exit 1
fi

echo "‚úÖ dist/server.js –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ server.js –Ω–µ—Ç vite
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã vite –≤ dist/server.js:"
if grep -q "vite" dist/server.js; then
    echo "‚ùå –í dist/server.js –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –∏–º–ø–æ—Ä—Ç—ã vite!"
    echo "üìã –ü–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏ —Å vite:"
    grep -n "vite" dist/server.js | head -3
    exit 1
else
    echo "‚úÖ –ò–º–ø–æ—Ä—Ç—ã vite –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ dist/server.js"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å dist/server.js..."
NODE_ENV=production pm2 start dist/server.js --name roleplayidentity

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
pm2 save

# –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
echo "‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å:"
pm2 status

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ vite:"
pm2 logs roleplayidentity --lines 10 --nostream | grep -i "vite\|error" || echo "–û—à–∏–±–æ–∫ vite –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º API
echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º API..."
response=$(curl -s http://localhost:5000/api/health)
echo "üìã –û—Ç–≤–µ—Ç API: $response"

if echo "$response" | grep -q "status.*ok"; then
    echo "‚úÖ API –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
    echo "üéâ –ü–†–û–ë–õ–ï–ú–ê –° VITE –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ê!"
else
    echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo "üìã –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:"
    curl -s http://localhost:5000/api/health
fi

echo "üéØ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û" 