#!/bin/bash

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° VITE –ù–ê VPS"
echo "================================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd /var/www/app

echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
if [ ! -f "package.json" ]; then
    echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $(pwd)"
    exit 1
fi

echo "‚úÖ package.json –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env
if [ ! -f ".env" ]; then
    echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "‚úÖ .env —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"

# –û–°–¢–ê–ù–û–í–ö–ê –°–¢–ê–†–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
if pm2 list | grep -q "roleplayidentity"; then
    echo "üìã –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å PM2:"
    pm2 list
    
    echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
    pm2 delete roleplayidentity
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    echo "‚ÑπÔ∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ"
fi

# –ü–†–û–í–ï–†–Ø–ï–ú –ö–ê–ö–û–ô –§–ê–ô–õ –ó–ê–ü–£–°–ö–ê–õ–°–Ø
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –µ—Å—Ç—å –≤ dist/:"
ls -la dist/

# –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–°–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ò (–≤–∫–ª—é—á–∞—è dev) –î–õ–Ø –°–ë–û–†–ö–ò
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏..."
npm ci

# –ü–ï–†–ï–°–ë–ò–†–ê–ï–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º entry point..."
npm run build

# –ü–†–û–í–ï–†–Ø–ï–ú –ß–¢–û –ü–†–ê–í–ò–õ–¨–ù–´–ô –§–ê–ô–õ –°–û–ó–î–ê–ù
if [ ! -f "dist/server.js" ]; then
    echo "‚ùå dist/server.js –Ω–µ —Å–æ–∑–¥–∞–Ω!"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ —Å–±–æ—Ä–∫–∏ –≤—ã—à–µ"
    exit 1
fi

echo "‚úÖ dist/server.js —Å–æ–∑–¥–∞–Ω"

# –ü–†–û–í–ï–†–Ø–ï–ú –†–ê–ó–ú–ï–† –§–ê–ô–õ–û–í
echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤:"
ls -lh dist/server.js
if [ -f "dist/index.js" ]; then
    ls -lh dist/index.js
fi

# –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –¢–û–õ–¨–ö–û PRODUCTION –ó–ê–í–ò–°–ò–ú–û–°–¢–ò
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm ci --production

# –ó–ê–ü–£–°–ö–ê–ï–ú –° –ü–†–ê–í–ò–õ–¨–ù–´–ú –§–ê–ô–õ–û–ú
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º..."
NODE_ENV=production pm2 start dist/server.js --name roleplayidentity

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
pm2 save

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
echo "‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 status

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
pm2 logs roleplayidentity --lines 15 --nostream

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if curl -f http://localhost:5000/api/health > /dev/null 2>&1; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:5000"
    echo "üéâ –ü–†–û–ë–õ–ï–ú–ê –° VITE –ò–°–ü–†–ê–í–õ–ï–ù–ê!"
else
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:5000"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    echo "üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 5000:"
    netstat -tlnp | grep :5000 || echo "–ü–æ—Ä—Ç 5000 –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è"
    
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º:"
    ls -la dist/server.js
    ls -la .env
    
    exit 1
fi

echo ""
echo "üîó –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É –≤–∞—à–µ–≥–æ VPS –Ω–∞ –ø–æ—Ä—Ç—É 5000"
echo "üìù –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ—Ä—Ç 5000 –æ—Ç–∫—Ä—ã—Ç –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ" 